 #include<reg52.h>       //°üº¬µ¥Æ¬»úŒÄŽæÆ÷µÄÍ·ÎÄŒþ
#include<intrins.h>  //°üº¬_nop_()º¯Êý¶šÒåµÄÍ·ÎÄŒþ
sbit IR=P3^2;           //œ«IRÎ»¶šÒåÎªP3.2ÒýœÅ
sbit RS=P2^0;    //ŒÄŽæÆ÷Ñ¡ÔñÎ»£¬œ«RSÎ»¶šÒåÎªP2.0ÒýœÅ
sbit RW=P2^1;    //¶ÁÐŽÑ¡ÔñÎ»£¬œ«RWÎ»¶šÒåÎªP2.1ÒýœÅ
sbit E=P2^2;     //Ê¹ÄÜÐÅºÅÎ»£¬œ«EÎ»¶šÒåÎªP2.2ÒýœÅ
sbit BF=P0^7;    //ÃŠÂµ±êÖŸÎ»£¬£¬œ«BFÎ»¶šÒåÎªP0.7ÒýœÅ
sbit BEEP = P3^6; //·äÃùÆ÷¿ØÖÆ¶Ë¿ÚP36 
unsigned char flag;
unsigned char code string[ ]= {"1602IR-CODE TEST"}; 
unsigned char a[4];    //Ž¢ŽæÓÃ»§Âë¡¢ÓÃ»§·ŽÂëÓëŒüÊýŸÝÂë¡¢ŒüÊýŸÝ·ŽÂë
unsigned int LowTime,HighTime; //Ž¢Žæžß¡¢µÍµçÆœµÄ¿í¶È 
unsigned char code hwyk[]={0x45,0x0c,0x18,0x5e,0x08,0x1c,0x5a,0x42,0x52,0x4a,0x16,0x0d,0x19,0x09,0x15,0x07};
 unsigned char  code mayuan[]={'F','1','2','3','4','5','6','7','8','9','0','/','*','-','+','=','E'};
/*****************************************************
º¯Êý¹ŠÄÜ£ºÑÓÊ±1ms
***************************************************/
void delay1ms()
{
   unsigned char i,j;	
	 for(i=0;i<10;i++)
	  for(j=0;j<33;j++)
	   ;		 
 }
 /*****************************************************
º¯Êý¹ŠÄÜ£ºÑÓÊ±ÈôžÉºÁÃë
Èë¿Ú²ÎÊý£ºn
***************************************************/
 void delay(unsigned char n)
 {
   unsigned char i;
	for(i=0;i<n;i++)
	   delay1ms();
 }



/*********************************************************/
void beep()		//·äÃùÆ÷ÏìÒ»Éùº¯Êý
{
  unsigned char i;
  for (i=0;i<100;i++)
   {
   delay1ms();
   BEEP=!BEEP;       //BEEPÈ¡·Ž
   } 
   BEEP=1;           //¹Ø±Õ·äÃùÆ÷
   delay(250);       //ÑÓÊ±     
}




/*****************************************************
º¯Êý¹ŠÄÜ£ºÅÐ¶ÏÒºŸ§Ä£¿éµÄÃŠÂµ×ŽÌ¬
·µ»ØÖµ£ºresult¡£result=1£¬ÃŠÂµ;result=0£¬²»ÃŠ
***************************************************/
 unsigned char BusyTest(void)
  {
    bit result;
	RS=0;       //žùŸÝ¹æ¶š£¬RSÎªµÍµçÆœ£¬RWÎªžßµçÆœÊ±£¬¿ÉÒÔ¶Á×ŽÌ¬
    RW=1;
    E=1;        //E=1£¬²ÅÔÊÐí¶ÁÐŽ
    _nop_();   //¿Õ²Ù×÷
    _nop_();
    _nop_(); 
    _nop_();   //¿Õ²Ù×÷ËÄžö»úÆ÷ÖÜÆÚ£¬žøÓ²Œþ·ŽÓŠÊ±Œä	
    result=BF;  //œ«ÃŠÂµ±êÖŸµçÆœž³žøresult
	E=0;
    return result;
  }
/*****************************************************
º¯Êý¹ŠÄÜ£ºœ«Ä£ÊœÉèÖÃÖžÁî»òÏÔÊŸµØÖ·ÐŽÈëÒºŸ§Ä£¿é
Èë¿Ú²ÎÊý£ºdictate
***************************************************/
void WriteInstruction (unsigned char dictate)
{   
    while(BusyTest()==1); //Èç¹ûÃŠŸÍµÈŽý
	 RS=0;                  //žùŸÝ¹æ¶š£¬RSºÍR/WÍ¬Ê±ÎªµÍµçÆœÊ±£¬¿ÉÒÔÐŽÈëÖžÁî
	 RW=0;   
	 E=0;                   //EÖÃµÍµçÆœ(žùŸÝ±í8-6£¬ÐŽÖžÁîÊ±£¬EÎªžßÂö³å£¬
                             // ŸÍÊÇÈÃEŽÓ0µœ1·¢ÉúÕýÌø±ä£¬ËùÒÔÓŠÏÈÖÃ"0"
	 _nop_();
	 _nop_();             //¿Õ²Ù×÷Áœžö»úÆ÷ÖÜÆÚ£¬žøÓ²Œþ·ŽÓŠÊ±Œä
	 P0=dictate;            //œ«ÊýŸÝËÍÈëP0¿Ú£¬ŒŽÐŽÈëÖžÁî»òµØÖ·
	 _nop_();
	 _nop_();
	 _nop_();
	 _nop_();               //¿Õ²Ù×÷ËÄžö»úÆ÷ÖÜÆÚ£¬žøÓ²Œþ·ŽÓŠÊ±Œä
	 E=1;                   //EÖÃžßµçÆœ
	 _nop_();
	 _nop_();
	 _nop_();
	 _nop_();               //¿Õ²Ù×÷ËÄžö»úÆ÷ÖÜÆÚ£¬žøÓ²Œþ·ŽÓŠÊ±Œä
	  E=0;                  //µ±EÓÉžßµçÆœÌø±ä³ÉµÍµçÆœÊ±£¬ÒºŸ§Ä£¿é¿ªÊŒÖŽÐÐÃüÁî
 }
/*****************************************************
º¯Êý¹ŠÄÜ£ºÖž¶š×Ö·ûÏÔÊŸµÄÊµŒÊµØÖ·
Èë¿Ú²ÎÊý£ºx
***************************************************/
 void WriteAddress(unsigned char x)
 {
     WriteInstruction(x|0x80); //ÏÔÊŸÎ»ÖÃµÄÈ·¶š·œ·š¹æ¶šÎª"80H+µØÖ·Âëx"
 }
/*****************************************************
º¯Êý¹ŠÄÜ£ºœ«ÊýŸÝ(×Ö·ûµÄ±ê×ŒASCIIÂë)ÐŽÈëÒºŸ§Ä£¿é
Èë¿Ú²ÎÊý£ºy(Îª×Ö·û³£Á¿)
***************************************************/
 void WriteData(unsigned char y)
 {
    while(BusyTest()==1);  
	  RS=1;           //RSÎªžßµçÆœ£¬RWÎªµÍµçÆœÊ±£¬¿ÉÒÔÐŽÈëÊýŸÝ
	  RW=0;
	  E=0;            //EÖÃµÍµçÆœ(žùŸÝ±í8-6£¬ÐŽÖžÁîÊ±£¬EÎªžßÂö³å£¬
                       // ŸÍÊÇÈÃEŽÓ0µœ1·¢ÉúÕýÌø±ä£¬ËùÒÔÓŠÏÈÖÃ"0"
	  P0=y;           //œ«ÊýŸÝËÍÈëP0¿Ú£¬ŒŽœ«ÊýŸÝÐŽÈëÒºŸ§Ä£¿é
	  _nop_();
	  _nop_();
 	  _nop_();
     _nop_();       //¿Õ²Ù×÷ËÄžö»úÆ÷ÖÜÆÚ£¬žøÓ²Œþ·ŽÓŠÊ±Œä
	  E=1;          //EÖÃžßµçÆœ
	  _nop_();
	  _nop_();
	  _nop_();
	 _nop_();        //¿Õ²Ù×÷ËÄžö»úÆ÷ÖÜÆÚ£¬žøÓ²Œþ·ŽÓŠÊ±Œä
	 E=0;            //µ±EÓÉžßµçÆœÌø±ä³ÉµÍµçÆœÊ±£¬ÒºŸ§Ä£¿é¿ªÊŒÖŽÐÐÃüÁî
 }
/*****************************************************
º¯Êý¹ŠÄÜ£º¶ÔLCDµÄÏÔÊŸÄ£ÊœœøÐÐ³õÊŒ»¯ÉèÖÃ
***************************************************/
void LcdInitiate(void)
{
   delay(15);             //ÑÓÊ±15ms£¬Ê×ŽÎÐŽÖžÁîÊ±ÓŠžøLCDÒ»¶ÎœÏ³€µÄ·ŽÓŠÊ±Œä
   WriteInstruction(0x38);  //ÏÔÊŸÄ£ÊœÉèÖÃ£º16¡Á2ÏÔÊŸ£¬5¡Á7µãÕó£¬8Î»ÊýŸÝœÓ¿Ú
	delay(5);   //ÑÓÊ±5ms¡¡
	WriteInstruction(0x38);
	delay(5);
	WriteInstruction(0x38);
	delay(5);
	WriteInstruction(0x0C);  //ÏÔÊŸÄ£ÊœÉèÖÃ£ºÏÔÊŸ¿ª£¬ÓÐ¹â±ê£¬¹â±êÉÁËž
	delay(5);
	WriteInstruction(0x06);  //ÏÔÊŸÄ£ÊœÉèÖÃ£º¹â±êÓÒÒÆ£¬×Ö·û²»ÒÆ
	delay(5);
	WriteInstruction(0x01);  //ÇåÆÁÄ»ÖžÁî£¬œ«ÒÔÇ°µÄÏÔÊŸÄÚÈÝÇå³ý
	delay(5);
 }
/************************************************************
º¯Êý¹ŠÄÜ£º¶Ô4žö×ÖœÚµÄÓÃ»§ÂëºÍŒüÊýŸÝÂëœøÐÐœâÂë
ËµÃ÷£ºœâÂëÕýÈ·£¬·µ»Ø1£¬·ñÔò·µ»Ø0
³ö¿Ú²ÎÊý£ºdat
*************************************************************/
bit DeCode(void)        
{
    
   unsigned char  i,j;
	unsigned char temp;    //Ž¢ŽæœâÂë³öµÄÊýŸÝ
	for(i=0;i<4;i++)      //Á¬Ðø¶ÁÈ¡4žöÓÃ»§ÂëºÍŒüÊýŸÝÂë
	  {
		 for(j=0;j<8;j++)  //Ã¿žöÂëÓÐ8Î»Êý×Ö
			 {
	         temp=temp>>1;  //tempÖÐµÄž÷ÊýŸÝÎ»ÓÒÒÆÒ»Î»£¬ÒòÎªÏÈ¶Á³öµÄÊÇµÍÎ»ÊýŸÝ									
			   TH0=0;         //¶šÊ±Æ÷Çå0
			   TL0=0;         //¶šÊ±Æ÷Çå0
			   TR0=1;         //¿ªÆô¶šÊ±Æ÷T0
		      while(IR==0)   //Èç¹ûÊÇµÍµçÆœŸÍµÈŽý
	               ;	      //µÍµçÆœŒÆÊ±
		  	   TR0=0;         //¹Ø±Õ¶šÊ±Æ÷T0
			   LowTime=TH0*256+TL0;    //±£ŽæµÍµçÆœ¿í¶È
			   TH0=0;         //¶šÊ±Æ÷Çå0
			   TL0=0;         //¶šÊ±Æ÷Çå0
			   TR0=1;         //¿ªÆô¶šÊ±Æ÷T0
			   while(IR==1)   //Èç¹ûÊÇžßµçÆœŸÍµÈŽý
			       ;			   
			   TR0=0;        //¹Ø±Õ¶šÊ±Æ÷T0
			   HighTime=TH0*256+TL0;   //±£ŽæžßµçÆœ¿í¶È
			   if((LowTime<370)||(LowTime>640))
			  		    return 0;        //Èç¹ûµÍµçÆœ³€¶È²»ÔÚºÏÀí·¶Î§£¬ÔòÈÏÎª³öŽí£¬Í£Ö¹œâÂë			
			   if((HighTime>420)&&(HighTime<620))   //Èç¹ûžßµçÆœÊ±ŒäÔÚ560Î¢Ãë×óÓÒ£¬ŒŽŒÆÊý560£¯1.085£œ516ŽÎ
			           temp=temp&0x7f;       //(520-100=420, 520+100=620)£¬ÔòžÃÎ»ÊÇ0
			   if((HighTime>1300)&&(HighTime<1800)) //Èç¹ûžßµçÆœÊ±ŒäÔÚ1680Î¢Ãë×óÓÒ£¬ŒŽŒÆÊý1680£¯1.085£œ1548ŽÎ
			           temp=temp|0x80;       //(1550-250=1300,1550+250=1800),ÔòžÃÎ»ÊÇ1
		     }  			            
	   a[i]=temp;	//œ«œâÂë³öµÄ×ÖœÚÖµŽ¢ŽæÔÚa[i]																					 
    }  				 		 
  if(a[2]==~a[3])  //ÑéÖ€ŒüÊýŸÝÂëºÍÆä·ŽÂëÊÇ·ñÏàµÈ,Ò»°ãÇé¿öÏÂ²»±ØÑéÖ€ÓÃ»§Âë
	 return 1;     //œâÂëÕýÈ·£¬·µ»Ø1
}

/*------------------¶þœøÖÆÂë×ª»»ÎªÑ¹ËõÐÍBCDÂë,²¢ÏÔÊŸ---------------*/


   void two_2_bcd(unsigned char date)
{
   unsigned char jieguo,jieguo1,jieguo2,key;
   unsigned char temp;
   temp=date;
   date&=0xf0;
   date>>=4;                    //ÓÒÒÆËÄÎ»µÃµœžßËÄÎ»Âë
   date&=0x0f; 
   jieguo1=date;                 //Óë0x0fÏëÓëÈ·±£žßËÄÎ»Îª0
  /* if(date<=0x09)
   {                 
     jieguo1=0x30+date;           
   }
   else
   {
     date=date-0x09;
	 jieguo1=0x40+date;
   }*/
   date=temp;
   date&=0x0f;
   jieguo2=date;
   /*if(date<=0x09)
   {
     jieguo2=0x30+date;            //lcdÏÔÊŸµÍËÄÎ»Öµ
   }
   else
   {
     date=date-0x09;
	 jieguo2=0x40+date;
   }*/
    WriteAddress(0x40);
  // WriteData(jieguo1);
  // WriteData(jieguo2);
  // WriteData(mayuan[0]);
  if(jieguo1==0x04&jieguo2==0x05){key=0;}
  else if(jieguo1==0x00&jieguo2==0x0c){key=1;}
   else if(jieguo1==0x01&jieguo2==0x08){key=2;}
    else if(jieguo1==0x05&jieguo2==0x0e){key=3;}
	 else if(jieguo1==0x00&jieguo2==0x08){key=4;}
	  else if(jieguo1==0x01&jieguo2==0x0c){key=5;}
	   else if(jieguo1==0x05&jieguo2==0x0a){key=6;}
	    else if(jieguo1==0x04&jieguo2==0x02){key=7;}
		 else if(jieguo1==0x05&jieguo2==0x02){key=8;}
		  else if(jieguo1==0x04&jieguo2==0x0a){key=9;}
		   else if(jieguo1==0x01&jieguo2==0x06){key=10;}
		    else if(jieguo1==0x00&jieguo2==0x0d){key=11;}
			 else if(jieguo1==0x01&jieguo2==0x09){key=12;}
			  else if(jieguo1==0x00&jieguo2==0x09){key=13;}
			   else if(jieguo1==0x01&jieguo2==0x05){key=14;}
			    else if(jieguo1==0x00&jieguo2==0x07){key=15;}
  else key=16;
  WriteAddress(0x40);
  WriteData(mayuan[key]);

} 
  unsigned char Disp(void){
  two_2_bcd(a[2]);
  
  }
/************************************************************
º¯Êý¹ŠÄÜ£º1602LCDÏÔÊŸ
*************************************************************/
 /*unsigned char Disp(void)
{  	 unsigned char i,j,key;
     key=16;
      // ÉèÖÃÏÔÊŸÎ»ÖÃÎªµÚÒ»ÐÐµÄµÚ1žö×Ö
      i=two_2_bcd(a[2]);
	 for(j=0;j<=15;j++)
        {
           if(i== hwyk[j])  //²é±íµÃŒüÖµ
           {
              key=j;
			  
			  }
             
           }  WriteAddress(0x40);
		   WriteData(mayuan[key]);
		    return(key);}	*/
	  
/************************************************************
º¯Êý¹ŠÄÜ£ºÖ÷º¯Êý
*************************************************************/
void main()
{
  	 unsigned char i;	
	LcdInitiate();         //µ÷ÓÃLCD³õÊŒ»¯º¯Êý  
    delay(10);
   		WriteInstruction(0x01);//ÇåÏÔÊŸ£ºÇåÆÁÄ»ÖžÁî
		WriteAddress(0x00);  // ÉèÖÃÏÔÊŸÎ»ÖÃÎªµÚÒ»ÐÐµÄµÚ1žö×Ö
	  	i = 0;
		while(string[i] != '\0')    //'\0'ÊÇÊý×éœáÊø±êÖŸ 
			{						// ÏÔÊŸ×Ö·û	WWW.RICHMCU.COM
				WriteData(string[i]);
				i++;	
			}
	EA=1;        //¿ªÆô×ÜÖÐ¶Ï
   EX0=1;       //¿ªÍâÖÐ¶Ï0
   ET0=1;       //¶šÊ±Æ÷T0ÖÐ¶ÏÔÊÐí
   IT0=1;       //ÍâÖÐ¶ÏµÄÏÂœµÑØŽ¥·¢  
    TMOD=0x01;   //Ê¹ÓÃ¶šÊ±Æ÷T0µÄÄ£Êœ1	
	TR0=0;       //¶šÊ±Æ÷T0¹Ø±Õ

   while(1);   //µÈŽýºìÍâÐÅºÅ²úÉúµÄÖÐ¶Ï
 	 
}
/************************************************************
º¯Êý¹ŠÄÜ£ººìÍâÏßŽ¥·¢µÄÍâÖÐ¶ÏŽŠÀíº¯Êý
*************************************************************/
void Int0(void) interrupt 0
  {
     EX0=0;      //¹Ø±ÕÍâÖÐ¶Ï0£¬²»ÔÙœÓÊÕ¶þŽÎºìÍâÐÅºÅµÄÖÐ¶Ï£¬Ö»œâÂëµ±Ç°ºìÍâÐÅºÅ
	  TH0=0;      //¶šÊ±Æ÷T0µÄžß8Î»Çå0
	  TL0=0;      //¶šÊ±Æ÷T0µÄµÍ8Î»Çå0
	  TR0=1;	    //¿ªÆô¶šÊ±Æ÷T0	 
	  while(IR==0);          //Èç¹ûÊÇµÍµçÆœŸÍµÈŽý£¬žøÒýµŒÂëµÍµçÆœŒÆÊ±
	  TR0=0;                //¹Ø±Õ¶šÊ±Æ÷T0     
	  LowTime=TH0*256+TL0;  //±£ŽæµÍµçÆœÊ±Œä
	  TH0=0;      //¶šÊ±Æ÷T0µÄžß8Î»Çå0
	  TL0=0;      //¶šÊ±Æ÷T0µÄµÍ8Î»Çå0
	  TR0=1;	    //¿ªÆô¶šÊ±Æ÷T0
	  while(IR==1);  //Èç¹ûÊÇžßµçÆœŸÍµÈŽý£¬žøÒýµŒÂëžßµçÆœŒÆÊ±
	  TR0=0;        //¹Ø±Õ¶šÊ±Æ÷T0
	  HighTime=TH0*256+TL0;	//±£ŽæÒýµŒÂëµÄžßµçÆœ³€¶È
     if((LowTime>7800)&&(LowTime<8800)&&(HighTime>3600)&&(HighTime<4700))
		 {
		    //Èç¹ûÊÇÒýµŒÂë,ŸÍ¿ªÊŒœâÂë,·ñÔò·ÅÆú,ÒýµŒÂëµÄµÍµçÆœŒÆÊ±
	       //ŽÎÊý£œ9000us/1.085=8294, ÅÐ¶ÏÇøŒä:8300£­500£œ7800£¬8300£«500£œ8800.
	      if(DeCode()==1) // ÖŽÐÐÒ£¿ØœâÂë¹ŠÄÜ
		 {
		
		  Disp();//µ÷ÓÃ1602LCDÏÔÊŸº¯Êý
		  beep();       //·äÃùÆ÷ÏìÒ»Éù ÌáÊŸœâÂë³É¹Š
		 }
		 }
	  EX0=1;   //¿ªÆôÍâÖÐ¶ÏEX0
  }
